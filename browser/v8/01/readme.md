# V8 如何执行一段 JavaScript 代码

## 什么是 V8

`V8` 是一个 Google 开源的 JavaScript 引擎。

我们可以这么想象 - 把 JavaScript 代码丢给 `V8`，`V8` 执行后输出结果。

> 为什么需要把代码丢给 `V8`？
>
> 也许你有疑问，为什么不能把代码直接丢给计算机？为什么要丢给 `V8`，这就需要从 CPU 的执行原理来说了。
>
> CPU 的工作实际上都是一些指令，通过输入不同的指令，CPU 执行不同的操作，而这些指令需要是二进制的（便于 CPU 理解），并且每个 CPU 厂商所提供的指令集也会有所不同，这就导致直接对 CPU 进行开发会变得异常复杂。
>
> 高级语言（C/C++、Java、JavaScript 等）的出现就是为了解决这种问题，他们屏蔽了计算机架构细节，开发者可以把关注点转义到业务逻辑代码了

或许也可以吧 `V8` 当做一个 "CPU"，这个 "CPU" 能够看懂我们编写的更加适合人类理解的代码，我们对着这个 "CPU" 编程，所以很多资料中，大家都将 `V8` 叫做 `虚拟机`。

1. `V8` 在执行我们编写的代码之前，需要进行一些初始化，准备一些执行所需的环境，它包括：

- 堆栈空间
- 全局执行上下文
- 消息循环系统
- 内置 API

等环境准备好之后，就可以向 `V8` 提交代码了

2. JavaScript 代码对于 `V8` 来说只是一堆字符串，`V8` 需要将他们 "结构化" 为 **A**bstract **S**yntax **T**rees（抽象语法树），同时还会生成相关作用域。

查看 `AST` 的命令：`d8 --print-ast test.js`

查看 `Scopes` 的命令：`d8 --print-scopes test.js`

3. AST 是方便 `V8` 理解的，但计算机并不理解，所以还需要将 `AST + 作用域`转换为*中间码*（也叫*字节码*）

> 中间码是一种面向语法的、易于翻译成目标程序的源程序等效内部表示代码，他有如下特点：
>
> - 可生成多种不同型号的目标机器代码
> - 可进行与机器无关的代码优化
>
> 假如一个中国人会英语不会日语，一个日本人会英语不会汉语，那么对于他们两人的交流来说，英语就是中间码

查看*字节码*的命令：`d8 --print-bytecode test.js`

4. 有了字节码就可以执行程序了，解释器会按照顺序执行字节码并输出执行结果。

5. 在解释器解释执行的时候，`V8` 有一个热点代码监控机制，当监控发现了重复执行的某段代码时，会将其标记为热点代码，并提交给编译器优化执行，此后如果代码没有被反优化，那么再次执行这段代码时，会使用编译后的代码。

查看*优化代码*的指令：`d8 --trace-opt test.js`

6. 如果经过编译后的代码其对象结构和属性在执行的过程中被修改了，那么 `V8` 还会执行反优化操作，将编译后的代码退回到解释器解释执行。

查看*反优化代码*的指令：`d8 --trace-deopt test.js`

## 什么是 d8？

`d8` 是 `V8` 的开发者 shell 工具，相当于 `V8` 自己的 CMD/Bash。

`d8` 是 `V8` 的源码编译之后输出的一个二进制可执行程序，下面是 `V8` 的构建文档和源码下载方式：

[Building V8 with GN](https://v8.dev/docs/build-gn) | [Checking out the V8 source code](https://v8.dev/docs/source-code)

也有说可以使用 `node` 代替 `d8` 的，不过我测试后 `node 12.14.1` 只有部分指令是支持的。

## 小结 🌹

V8 是一个 JavaScript 引擎，也被成为虚拟机

V8 执行一段 JavaScript 代码的流程：

- 准备基础环境
- 解析输入的源码，生成 AST 和 Scopes
- 使用 AST 和 Scopes 生成 bytecode
- 解释执行字节码，并监听热点代码
- 存在热点代码：优化热点代码为二进制的机器代码（编译）
- 热点代码被修改：反优化热点代码
